package Tools;

import Utils.HandleFiles;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.*;
import java.io.*;
import java.math.BigInteger;
import java.net.URL;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Base64;
import java.util.Formatter;
import java.util.ResourceBundle;
import java.util.Scanner;

public class EncoderToolController implements Initializable
{

    @FXML private Button EncodeButton;
    @FXML private Button DecodeButton;
    @FXML private TextArea PlainTextBox;
    @FXML private TextArea EncodeTextBox;
    @FXML private Button LoadPlainTextButton;
    @FXML private Button SavePlainTextButton;
    @FXML private Button LoadEncodeTextButton;
    @FXML private Button SaveEncodeTextButton;
    @FXML private ComboBox MethodComboBox;
    @FXML private TextField DelimiterTextBox;
    @FXML private CheckBox TextCheckBox;
    @FXML private CheckBox HexCheckBox;
    @FXML private MenuItem fileOpen;

    private String encodeResult;
    private String decodeResult;
    private String encodeMethod;
    private String plainText;
    private String encodeText;


    HandleFiles handleFiles = new HandleFiles();

    @Override
    public void initialize(URL location, ResourceBundle resources) {

        //Encode Decode Methods
        MethodComboBox.getItems().addAll(
                "Base 64",
                "Hex",
                "HTTP",
                "HTTP (Full)",
                "Unicode",
                "HTML (Simple)",
                "MD5",
                "SHA1"
        );
        MethodComboBox.getSelectionModel().selectFirst();
        MethodComboBox.setOnAction(event -> {
            if ((MethodComboBox.getValue() == "MD5") || (MethodComboBox.getValue() == "SHA1")){
                DecodeButton.setDisable(true);
                LoadEncodeTextButton.setDisable(true);
            }else {
                DecodeButton.setDisable(false);
                LoadEncodeTextButton.setDisable(false);
            }
        });


//        //Control text typed on PlainTextBox
//        PlainTextBox.setOnKeyPressed(event -> {
//
//        });



        LoadPlainTextButton.setOnAction(event -> {
            File file = handleFiles.OpenFileDialog("TXT files (*.txt)","*.txt","Open Text File");
            if (file != null) {
                System.out.println(file.getName());

                try {
                    Scanner s = new Scanner(file).useDelimiter("\\s+");
                    while (s.hasNext()) {
                        if (s.hasNextInt()) { // check if next token is an int
                            PlainTextBox.appendText(s.nextInt() + " "); // display the found integer
                        } else {
                            PlainTextBox.appendText(s.next() + " "); // else read the next token
                        }
                    }
                } catch (FileNotFoundException ex) {
                    System.err.println(ex);
                }
        }});


        EncodeButton.setOnAction(event -> {
            encodeMethod = MethodComboBox.getValue().toString();
            plainText = PlainTextBox.getText();
            switch (encodeMethod){
                case "Base 64":
                    encodeResult = Base64Encode(plainText);
                    EncodeTextBox.setText(encodeResult);
                    break;
                case "Hex":
                    encodeResult = HexEncode(plainText.getBytes());
                    EncodeTextBox.setText(encodeResult);
                    break;
                case "HTTP":
                    encodeResult = HTTPEncode(plainText);
                    break;
                case "HTTP (Full)":
                    encodeResult = HTTPFullEncode(plainText);
                    break;
                case "Unicode":
                    encodeResult = UnicodeEncode(plainText);
                    break;
                case "HTML (Simple)":
                    encodeResult = HTMLEncode(plainText);
                    break;
                case "MD5":
                    encodeResult = MD5Encode(plainText);
                    EncodeTextBox.setText(encodeResult);
                    break;
                case "SHA1":
                    encodeResult = SHA1Encode(plainText);
                    EncodeTextBox.setText(encodeResult);
                    break;
            }

        });

        DecodeButton.setOnAction(event -> {
            encodeMethod = MethodComboBox.getValue().toString();
            encodeText = EncodeTextBox.getText();
            switch (encodeMethod){
                case "Base 64":
                    decodeResult = Base64Decode(encodeText);
                    PlainTextBox.setText(decodeResult);
                    break;
                case "Hex":
                    decodeResult = HexDecode(encodeText);
                    PlainTextBox.setText(decodeResult);
                    break;
                case "HTTP":
                    encodeResult = HTTPEncode(plainText);
                    break;
                case "HTTP (Full)":
                    encodeResult = HTTPFullEncode(plainText);
                    break;
                case "Unicode":
                    encodeResult = UnicodeEncode(plainText);
                    break;
                case "HTML (Simple)":
                    encodeResult = HTMLEncode(plainText);
                    break;
            }
        });
    }
    
    //MD5
    private String MD5Encode(String plainText) {
        String md5;
        try {
            MessageDigest mdEnc = MessageDigest.getInstance("MD5"); //Encryption algorithm
            mdEnc.update(plainText.getBytes(), 0, plainText.length());
            md5 = new BigInteger(1, mdEnc.digest()).toString(16); // Encrypted string
        }
        catch (Exception ex) {
            return null;
        }
        return md5;
    }

    //SHA1
    private String SHA1Encode(String plainText) {
        String sha1 = "";
        try
        {
            MessageDigest crypt = MessageDigest.getInstance("SHA-1");
            crypt.reset();
            crypt.update(plainText.getBytes("UTF-8"));
            sha1 = byteToHex(crypt.digest());
        }
        catch(NoSuchAlgorithmException e)
        {
            e.printStackTrace();
        }
        catch(UnsupportedEncodingException e)
        {
            e.printStackTrace();
        }
        return sha1;
    }
    private static String byteToHex(final byte[] hash){
        Formatter formatter = new Formatter();
        for (byte b : hash)
        {
            formatter.format("%02x", b);
        }
        String result = formatter.toString();
        formatter.close();
        return result;
    }

    private String HTMLEncode(String plainText) {
        return plainText;
    }

    private String UnicodeEncode(String plainText) {
        return plainText;
    }

    private String HTTPFullEncode(String plainText) {
        return plainText;
    }

    private String HTTPEncode(String plainText) {
        return plainText;
    }

    //HEX
    private String HexEncode(byte[] data) {
        StringBuffer buf = new StringBuffer();
        for (int i = 0; i < data.length; i++) {
            int half_byte = (data[i] >>> 4) & 0x0F;
            int two_half = 0;
            do {
                if ((0 <= half_byte) && (half_byte <= 9)) {
                    buf.append((char) ('0' + half_byte));
                } else {
                    buf.append((char) ('a' + (half_byte - 10)));
                }
                half_byte = data[i] & 0x0F;
            } while (two_half++ < 1);
        }
        return buf.toString();
    }
    private String HexDecode(String encodeText) {

        StringBuilder output = new StringBuilder();

        for (int i = 0; i < encodeText.length(); i += 2) {
            String str = encodeText.substring(i, i + 2);
            output.append((char) Integer.parseInt(str, 16));
        }
        return output.toString();
    }

    //BASE 64
    private String Base64Encode(String plainText) {
        String asB64 = Base64.getEncoder().encodeToString(plainText.getBytes());
        return asB64;
    }
    private String Base64Decode(String encodeText) {
        byte[] asBytes = Base64.getDecoder().decode(encodeText);
        return new String(asBytes);
    }

}
